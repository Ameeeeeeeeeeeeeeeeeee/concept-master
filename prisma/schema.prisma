generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  STUDENT
  ADMIN
}

model User {
  id            String       @id @default(cuid())
  name          String
  email         String       @unique
  password      String
  role          Role         @default(STUDENT)
  grade         Int?
  streak        Int          @default(0)
  lastActive    DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  bookmarks     Bookmark[]
  quizResults   QuizResult[]
  aiHistory     AIHistory[]
  progress      Progress[]

  @@index([email])
  @@index([role])
}

model Grade {
  id       String    @id @default(cuid())
  number   Int       @unique
  label    String
  subjects Subject[]

  @@index([number])
}

model Subject {
  id      String  @id @default(cuid())
  name    String
  slug    String
  icon    String?
  gradeId String
  grade   Grade   @relation(fields: [gradeId], references: [id], onDelete: Cascade)
  topics  Topic[]

  @@unique([slug, gradeId])
  @@index([gradeId])
}

model Topic {
  id        String    @id @default(cuid())
  title     String
  slug      String
  order     Int       @default(0)
  subjectId String
  subject   Subject   @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  concepts  Concept[]

  @@unique([slug, subjectId])
  @@index([subjectId])
}

model Concept {
  id          String     @id @default(cuid())
  title       String
  slug        String
  content     String?    @db.Text
  explanation String?    @db.Text
  examples    String?    @db.Text
  formulas    String?    @db.Text
  order       Int        @default(0)
  topicId     String
  topic       Topic      @relation(fields: [topicId], references: [id], onDelete: Cascade)
  bookmarks   Bookmark[]
  quizzes     Quiz[]

  @@unique([slug, topicId])
  @@index([topicId])
}

model Quiz {
  id        String       @id @default(cuid())
  question  String       @db.Text
  options   String[]
  answer    Int
  explanation String?    @db.Text
  difficulty String      @default("medium")
  conceptId String?
  concept   Concept?     @relation(fields: [conceptId], references: [id], onDelete: SetNull)
  subject   String?
  topic     String?
  grade     Int?
  results   QuizResult[]
  createdAt DateTime     @default(now())

  @@index([conceptId])
  @@index([subject])
  @@index([grade])
}

model QuizResult {
  id        String   @id @default(cuid())
  userId    String
  quizId    String
  selected  Int
  correct   Boolean
  score     Float
  subject   String?
  topic     String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz      Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([quizId])
  @@index([userId, subject])
}

model Bookmark {
  id        String   @id @default(cuid())
  userId    String
  conceptId String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  concept   Concept  @relation(fields: [conceptId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, conceptId])
  @@index([userId])
}

model AIHistory {
  id        String   @id @default(cuid())
  userId    String?
  query     String   @db.Text
  response  String   @db.Text
  subject   String?
  type      String   @default("ask")
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([subject])
  @@index([createdAt])
}

model Progress {
  id        String   @id @default(cuid())
  userId    String
  grade     Int
  subject   String
  topic     String
  concept   String
  completed Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, grade, subject, topic, concept])
  @@index([userId])
  @@index([userId, grade, subject])
}

model DailyChallenge {
  id        String   @id @default(cuid())
  question  String   @db.Text
  options   String[]
  answer    Int
  explanation String? @db.Text
  subject   String
  grade     Int
  date      DateTime @unique @db.Date
  createdAt DateTime @default(now())

  @@index([date])
}

model Analytics {
  id        String   @id @default(cuid())
  event     String
  data      String?  @db.Text
  userId    String?
  createdAt DateTime @default(now())

  @@index([event])
  @@index([createdAt])
}
